<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Zemian's Blog &middot; Life in programming world!
    
  </title>

  
  <link rel="canonical" href="http://localhost:4000/page25/">
  

  <link rel="stylesheet" href="http://localhost:4000/public/css/poole.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-135626598-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A weblog on software development.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item active" href="http://localhost:4000/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/about/">About</a>
        
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Zemian's Blog</a>
            <small>Life in programming world!</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/08/17/how-to-integrate-timemachine-scheduler-in-spring-based-application/">
        How to integrate TimeMachine Scheduler in Spring based application
      </a>
    </h1>

    <span class="post-date">17 Aug 2012</span>

    <p>One of the goals for <a href="https://bitbucket.org/timemachine/scheduler">TimeMachine Scheduler</a> is to make use of POJO as friendly as possible so that we can integrate into any IoC container easily. I’ve prepared a demo that will show you how to integrate TimeMachine with <a href="http://www.springsource.org/">Spring</a> based application.</p>

<p>We will mainly focus on the Spring xml config part in this article, so if you don’t feel like checking out the  <a href="https://bitbucket.org/timemachine/scheduler-demo/src/fab518eb64ce/scheduler-spring">demo project source code</a> in details, then simply grab the binary package of the  <a href="https://bitbucket.org/timemachine/scheduler-demo/downloads">timemachine-spring-demo.zip</a> and follow along.</p>

<h1 id="introducing-a-tiny-spring-server">Introducing a tiny Spring Server</h1>

<p>If you don’t already have a Spring project going, then take a look at my little Spring server. It can bootstrap any spring configuration xml file and then sits and wait for a <code class="language-plaintext highlighter-rouge">CTRL+C</code> to end. Unzip the demo and try it out like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd timemachine-spring-demo
$ bin/run-spring config/hello-spring.xml
</code></pre></div></div>

<p>You should see a “Hello World!” message printed. Hit <code class="language-plaintext highlighter-rouge">CTRL+C</code> to end it. The xml just declares a simple <code class="language-plaintext highlighter-rouge">HelloService</code> bean like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;beans xmlns="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;
    
        &lt;bean id="helloService" class="timemachine.spring.HelloService" init-method="run"&gt;
            &lt;property name="name" value="World"&gt;&lt;/property&gt;
        &lt;/bean&gt;
    
    &lt;/beans&gt;
</code></pre></div></div>

<p>That’s your typical Spring declaration file. With this tiny Spring server, you can quickly experiment any POJOs wired up in any way you wish and put them in action.</p>

<h1 id="setting-up-timemachine-scheduler-beans">Setting up TimeMachine Scheduler beans</h1>

<p>In Java code, you can easily create an instance of the TimeMachine scheduler as follow:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    SchedulerFactory schedulerFactory = new SchedulerFactory("config/scheduler.properties");
    Scheduler scheduler = schedulerFactory.createScheduler();
    scheduler.start();
    // Then we would also need to call scheduler.destroy() before we exit the Java program. (eg: in shutdownHook)
</code></pre></div></div>

<p>You can easily translate that into Spring xml config like in <code class="language-plaintext highlighter-rouge">config/timemachine-pojo-spring.xml</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;beans xmlns="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;
    
        &lt;bean id="schedulerFactory" class="timemachine.scheduler.SchedulerFactory"&gt;
            &lt;constructor-arg value="config/scheduler.properties"&gt;&lt;/constructor-arg&gt;
        &lt;/bean&gt;
        &lt;bean id="scheduler" class="timemachine.scheduler.Scheduler" 
            factory-bean="schedulerFactory" factory-method="createScheduler"
            init-method="start" destroy-method="destroy"&gt;
        &lt;/bean&gt;
    
    &lt;/beans&gt;
</code></pre></div></div>

<p>The benefit of using Spring xml is that your scheduler lifecycles would be automatically taken care of without setting any shutdown hook. Running above should give you a plain scheduler started, and pressing <code class="language-plaintext highlighter-rouge">CTRL+C</code> should shutdown gracefully.</p>

<h1 id="going-further-with-a-custom-schedulerfactorybean">Going further with a custom SchedulerFactoryBean</h1>

<p>Now above is not much excitement using Spring since you would still configure the scheduler through <code class="language-plaintext highlighter-rouge">config/scheduler.properties</code>. You certainly can load jobs and add custom services there. But if we are going to use Spring, we might as well take full advantage of it to create the Job Definition and Schedule inside the xml config! To do this, I created a simple <code class="language-plaintext highlighter-rouge">timemachine.scheduler.spring.SchedulerFactoryBean</code> in my demo project, and you can try it out like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;beans xmlns="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;
    
        &lt;bean id="scheduler" class="timemachine.scheduler.spring.SchedulerFactoryBean"&gt;
            &lt;property name="configPropsUrl" value="config/scheduler.properties"&gt;&lt;/property&gt;
            &lt;property name="autoStart" value="true"&gt;&lt;/property&gt;
            &lt;property name="autoAddJobDef" value="true"&gt;&lt;/property&gt;
        &lt;/bean&gt;
        &lt;bean id="jobDef01" class="timemachine.scheduler.JobDef"&gt;
            &lt;property name="jobTaskClassName" value="timemachine.scheduler.jobtask.ScriptingJobTask"&gt;&lt;/property&gt;
            &lt;property name="props"&gt;
                &lt;map&gt;
                    &lt;entry key="scriptEngineName" value="Groovy"&gt;&lt;/entry&gt;
                    &lt;entry key="scriptText" value="println('Hello World.')"&gt;&lt;/entry&gt;
                &lt;/map&gt;
            &lt;/property&gt;
            &lt;property name="schedules"&gt;
                &lt;list&gt;              
                    &lt;bean class="timemachine.scheduler.schedule.CronSchedule"&gt;
                        &lt;property name="expression" value="0/3 * * * * ?"&gt;&lt;/property&gt;
                    &lt;/bean&gt;
                &lt;/list&gt;
            &lt;/property&gt;
        &lt;/bean&gt;
    
    &lt;/beans&gt;
</code></pre></div></div>

<p>Above will create not only the scheduler but also auto manage the lifecycles for you without you explicitly declare it. The factory bean will also auto detect any JobDef and Schedule bean types and add them into the scheduler instance. This would make your scheduler config all in the Spring xml, and it’s well integrated.</p>

<p>There is also another similar sample in <code class="language-plaintext highlighter-rouge">config/timemachine-spring.xml</code> you may try. It will invoke an external groovy script instead of inline text.</p>

<h1 id="going-extra-mile-on-exposing-timemachine-scheduler-through-jmx">Going extra mile on exposing TimeMachine Scheduler through JMX</h1>

<p>The TimeMachine doesn’t support any JMX instrumentation, however when running with the Spring, you can easily expose any Java interface to the local MBean Server Platform using Spring’s MBeanExporter. For example in <code class="language-plaintext highlighter-rouge">config/timemachine-jmx-spring.xml</code> you will see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;beans xmlns="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;
    
        &lt;bean id="scheduler" class="timemachine.scheduler.spring.SchedulerFactoryBean"&gt;
            &lt;property name="configPropsUrl" value="config/scheduler.properties"/&gt;
        &lt;/bean&gt; 
        &lt;bean id="exporter" class="org.springframework.jmx.export.MBeanExporter"&gt;
            &lt;property name="assembler"&gt;
                &lt;bean class="org.springframework.jmx.export.assembler.InterfaceBasedMBeanInfoAssembler"&gt;
                    &lt;property name="managedInterfaces"&gt;
                        &lt;list&gt;
                            &lt;value&gt;timemachine.scheduler.Scheduler&lt;/value&gt;
                        &lt;/list&gt;
                    &lt;/property&gt;
                &lt;/bean&gt;
            &lt;/property&gt;
            &lt;property name="beans"&gt;
                &lt;map&gt;
                    &lt;entry key="timemachine.scheduler:name=Scheduler" value-ref="scheduler"/&gt;
                &lt;/map&gt;
            &lt;/property&gt;
        &lt;/bean&gt;
    
    &lt;/beans&gt;
</code></pre></div></div>

<p>Above will start an empty scheduler, and expose the <code class="language-plaintext highlighter-rouge">timemachine.scheduler.Scheduler</code> interface to the JMX local server. You may use <code class="language-plaintext highlighter-rouge">$JAVA_HOME/bin/jconsole</code> to connect and will see all the methods automatically exposed. There few methods that contains custom java objects that exporter will not able to convert properly, but at least you will get all the lifecycles and some simple getters that available to you.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/08/14/how-to-make-an-executable-war-file/">
        How to make an executable WAR file
      </a>
    </h1>

    <span class="post-date">14 Aug 2012</span>

    <p>If you ever used <a href="http://jenkins-ci.org">Jenkin</a> CI server, you have probably seen their super easy one-line instruction to get started: <code class="language-plaintext highlighter-rouge">java -jar jenkins.war</code>. Now that’s one awesome way to get your users to try out your product!</p>

<p>In this article, I will show you how to make a WAR file self executable just like above. Before I do that, let me tell you a little web app that I made, and then I will show how I converted it into runnable <code class="language-plaintext highlighter-rouge">war</code>.</p>

<h2 id="the-requirement-taking-notes-efficiently">The Requirement: Taking Notes Efficiently</h2>

<p>I tend take a lot of notes when I do my work. Instead of using the crapy Windows Notepad.exe, I would setup my cygwin <code class="language-plaintext highlighter-rouge">.bash_profile</code> like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function e() { /cygdrive/C/apps/notepad++.exe $(cygpath -w "$@") ; }
function n() { F="$HOME/notes/$(date "+%Y%m%d-%H%M%S").markdown"; touch $F; e $F; }
</code></pre></div></div>

<p>I happen to have <a href="http://notepad-plus-plus.org">Notepad++</a> installed, but you can use just about any text editor you like. With that setup, then anywhere in my terminal I can simply type <code class="language-plaintext highlighter-rouge">n</code> to have a GUI editor pop open, and I will have my note file ready to record notes. The file name would have a timestamp date, and I like to record them with simple <code class="language-plaintext highlighter-rouge">Markdown</code> syntax for easy viewing later. Since I write them in plain text, it’s easy and fast to search using <code class="language-plaintext highlighter-rouge">grep MYSTUFF ~/notes/*</code>. Once I found it, I can quickly edit it by <code class="language-plaintext highlighter-rouge">e ~/notes/20120814-000000.markdown</code>.</p>

<p>This method of taking notes is fast and portable between my Linux and Windows systems (well, I have to choose a different editor between OS but not big deal). Now since I already recorded my notes in markdown, there is no way I can see the pretty result unless I use an <a href="http://daringfireball.net/projects/markdown/dingus">online converter</a>. So I thought it would be awesome if I can have a web app that let me record these notes, and yet give me a nice quick <code class="language-plaintext highlighter-rouge">Markdown</code> to html view.</p>

<h2 id="introducing-the-webnotepadwar">Introducing the webnotepad.war</h2>

<p>To improve my notes taking, I created little web app called <a href="https://bitbucket.org/saltnlight5/sandbox/downloads">webnotepad.war</a>. It’s really simply one page web app that record notes in Markdown syntax, preview it, and allow you to search it. It also let you edit old notes too. The whole thing is just a Servlet class, and it doesn’t even use JSP.</p>

<p>However, after I have this little web app, it bothers me that I would always need an app server to run it. (I can run <code class="language-plaintext highlighter-rouge">mvn tomcat7:run</code> directly from my source project, but it would require me be online to satisfy initial Maven build.) So here is a perfectly example use case that would be super nice to make this war file self executable. In fact I have succeeded in this little experiement. You can download it and try it out yourself with <code class="language-plaintext highlighter-rouge">java -jar webnotepad.war</code>, and then browse <code class="language-plaintext highlighter-rouge">http://localhost:8080</code>. If you get port conflict, try <code class="language-plaintext highlighter-rouge">--httpPort=8081</code>.</p>

<p>Of course you continue to deploy <code class="language-plaintext highlighter-rouge">webnotepad.war</code> into any app server too.</p>

<h2 id="making-war-file-executable">Making war file executable</h2>

<p>Before you want to make war executable, you want to build and package your normal web application first. The trick to make the war file runnable is that you want additionally add a Main-Class in the <code class="language-plaintext highlighter-rouge">META-INF/MANIFEST.MF</code> in the war file. And from this we need to load and run an embedded Servlet server with the self war file deployed. I noticed Jenkins uses one called <a href="winstone.sourceforge.net">Winstone</a> container server. I was amazed to find that this server only has 300K in size! It support full Servlet 2.5 spec! It can optionally support JSP with Jasper which will cost you up to 3MB in size. That’s still a very small price to pay compare to any Servlet container out there!</p>

<p>Making a Main-Class <a href="https://bitbucket.org/saltnlight5/sandbox/src/4e80e4b4114e/webnotepad/src/main/winstone/WinstoneMain.java">WinstoneMain.java</a> is not hard. However making Maven to package everything is pretty tricky. Now my <code class="language-plaintext highlighter-rouge">webnotepad.war</code> doesn’t need Jasper, but if you do, you specially want these jars outside of <code class="language-plaintext highlighter-rouge">WEB-INF/lib</code> because you don’t want your normal app server to load these! Else you will get very odd errors.</p>

<p>In my example I added into <code class="language-plaintext highlighter-rouge">WEB-INF/lib-winstone</code>, and then the <code class="language-plaintext highlighter-rouge">WinstoneMain</code> would extract these and then load the <code class="language-plaintext highlighter-rouge">winstone.Launcher</code> using a custom class loader. Also, we need to use some Winstone options to start a web server properly. I use this <a href="https://bitbucket.org/saltnlight5/sandbox/src/4e80e4b4114e/webnotepad/pom.xml">webnotepad/pom.xml</a> to package it all up the war file. You can easily use my example because I have create them under a separate <code class="language-plaintext highlighter-rouge">profile</code> and you just need add to your web module/pom.xml. In my project demo you would run <code class="language-plaintext highlighter-rouge">mvn package -Pdist</code> to generate the executable war file.</p>

<p>NOTE: I noticed Winstone project didn’t show much activity since last release since 2008. But I was happy to find that there is a fork project on <a href="http://code.google.com/p/winstone/">GoogleCode Winstone</a> that shows activities. I didn’t use this for my demo, but it looks promising.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/08/11/checking-db-connection-using-java/">
        Checking DB Connection using Java
      </a>
    </h1>

    <span class="post-date">11 Aug 2012</span>

    <p>For complete sake, here is a Java version of the http://saltnlight5.blogspot.com/2012/12/checking-db-connection-using-groovy.html[Groovy post] to test your Oracle Database connection.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package atest;
import java.sql.*;
/**
 * Run arguments sample:
 * jdbc:oracle:thin:@localhost:1521:XE system mypassword123 oracle.jdbc.driver.OracleDriver
 */
public class DbConn {
    public static void main(String[] args) throws Exception {
        String url = args[0];
        String username = args[1];
        String password = args[2];
        String driver = args[3];

        Class.forName(driver);
        Connection conn = DriverManager.getConnection(url, username, password);
        try {
            Statement statement = conn.createStatement();
            ResultSet rs = statement.executeQuery("SELECT SYSDATE FROM DUAL");
            while(rs.next()) {
                System.out.println(rs.getObject(1));
            }
        } finally {
            conn.close();
        }
    }
}
</code></pre></div></div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/08/06/how-to-generate-redmine-war-application-to-run-with-java/">
        How to generate Redmine WAR application to run with Java
      </a>
    </h1>

    <span class="post-date">06 Aug 2012</span>

    <p>If you survey around Java open source land, it’s really disappointing in not able to  find a decent project management web app that we can use. The Java war file deployment in an app server is easy to use, and it would give us good performance. Especially if we already in a Java shop, having a project management tool that deploys in an existing app server would be easier to maintain.</p>

<p>I have found the Ruby’s <a href="http://www.redmine.org">Redmine</a> to be a very good ONE-STOP-SHOP for most of your project development need. It has nice clean web interface, and the features are loaded: projects, users, issue tracking, wiki, source control viewer, documents, and it even has time tracking.</p>

<p>Altough the application is written in Ruby on Rails, you can run this with the JRuby perfectly fine on any Java app server. I’ve just done this and able to run it on JBossAS7.1.0 with jruby-1.6.7.2 and redmine-2.03.</p>

<p>For the impatients, you can actually grab my generated <code class="language-plaintext highlighter-rouge">redmine-2.0.3.war</code> from <a href="https://bitbucket.org/saltnlight5/sandbox/downloads">my sandbox</a>. I even provided an MySQL sql dump for you to get started without have to go through the building the war file. If you want to change the DB or any other settings, you can simply unpack the war file and edit the config files, then re-jar the war backup. This is still easier than building the war from scratch.</p>

<p>Here is how I build the war file. First step is setup a database. I picked MySQL.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; create database redmine character set utf8;
mysql&gt; create user 'redmine'@'localhost' identified by 'redmine123';
mysql&gt; grant all privileges on redmine.* to 'redmine'@'localhost';
</code></pre></div></div>

<p>Then prepare the Redmine with JRuby. Download the <code class="language-plaintext highlighter-rouge">redmine-2.0.3.zip</code> and unzip and then cd into this directory. Then run the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ $JRUBY_HOME/bin/gem install bundler
$ $JRUBY_HOME/bin/bundle install --without development test rmagick postgresql sqlite
$ cp config/database.yml.example config/database.yml
$ # edit config/database.yml
$ # type in your database connection info for "production" env.
$ $JRUBY_HOME/bin/rake generate_secret_token
$ RAILS_ENV=production $JRUBY_HOME/bin/rake db:migrate
$ RAILS_ENV=production $JRUBY_HOME/bin/rake redmine:load_default_data
</code></pre></div></div>

<p>Now create the war file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ $JRUBY_HOME/bin/gem install warbler
$ $JRUBY_HOME/bin/warble config
$ # edit config/warble.rb
$ # replace: config.dirs = %w(app config lib log vendor tmp extra files)
$ # add: config.gems += ["activerecord-jdbcmysql-adapter", "jruby-openssl", "i18n", "rack"]
$ $JRUBY_HOME/bin/warble
</code></pre></div></div>

<p>After this, you will see <code class="language-plaintext highlighter-rouge">redmine-2.0.3.war</code> in the directory. Now you can drop it into any app server and you may kick start any projects!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/08/03/timemachine-jars-size-and-dependencies/">
        TimeMachine jars size and dependencies
      </a>
    </h1>

    <span class="post-date">03 Aug 2012</span>

    <p>From the <a href="https://bitbucket.org/timemachine/scheduler/downloads">TimeMachine Scheduler</a> download page you will see that the latest 1.2.1 release zip package size is around 13M. It may seem large for a scheduler application, but let’s examine it closely to see what’s in there. Here is how the zip package looks like inside</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    timemachine-scheduler-1.2.1
    +-- bin
    +-- lib
    +-- config
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">config</code> directory contains many sample configurations and scripts to help new users get started. The <code class="language-plaintext highlighter-rouge">bin</code> contains few startup wrapper scripts that let you start the scheduler. The <code class="language-plaintext highlighter-rouge">lib</code> contains the libraries for the scheduler application. I want to go into more details on these.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    +-- lib
    -rw-r--r--@  1 zemian  staff   445288 Jun 20 23:20 antlr-2.7.7.jar
    -rw-r--r--@  1 zemian  staff   610790 Jun 20 23:26 c3p0-0.9.1.2.jar
    -rw-r--r--@  1 zemian  staff   109043 Jun 20 23:20 commons-io-1.4.jar
    -rw-r--r--@  1 zemian  staff   279193 Jun 20 23:20 commons-lang-2.5.jar
    -rw-r--r--@  1 zemian  staff   313898 Jun 20 23:26 dom4j-1.6.1.jar
    -rw-r--r--@  1 zemian  staff  6156866 Aug  2 22:05 groovy-all-2.0.0.jar
    -rw-r--r--@  1 zemian  staff  1267149 Jun 20 23:26 h2-1.3.163.jar
    -rw-r--r--@  1 zemian  staff    81271 Jun 20 23:26 hibernate-commons-annotations-4.0.1.Final.jar
    -rw-r--r--@  1 zemian  staff  4407494 Jun 20 23:26 hibernate-core-4.1.3.Final.jar
    -rw-r--r--@  1 zemian  staff   102661 Jun 20 23:26 hibernate-jpa-2.0-api-1.0.1.Final.jar
    -rw-r--r--@  1 zemian  staff   648253 Jun 20 23:26 javassist-3.15.0-GA.jar
    -rw-r--r--@  1 zemian  staff    60768 Jun 20 23:26 jboss-logging-3.1.0.GA.jar
    -rw-r--r--@  1 zemian  staff    11209 Jun 20 23:26 jboss-transaction-api_1.1_spec-1.0.0.Final.jar
    -rw-r--r--@  1 zemian  staff   481535 Jun 20 23:20 log4j-1.2.16.jar
    -rw-r--r--@  1 zemian  staff    25496 Jun 20 23:20 slf4j-api-1.6.1.jar
    -rw-r--r--@  1 zemian  staff     9753 Jun 20 23:20 slf4j-log4j12-1.6.1.jar
    -rw-r--r--@  1 zemian  staff    46885 Aug  2 22:37 timemachine-hibernate-1.2.1.jar
    -rw-r--r--@  1 zemian  staff   154925 Aug  2 22:36 timemachine-scheduler-1.2.1.jar
</code></pre></div></div>

<p>The core of the scheduler <code class="language-plaintext highlighter-rouge">timemachine-scheduler-1.2.1.jar</code> would only need <code class="language-plaintext highlighter-rouge">slf4j-api-1.6.1.jar</code>, <code class="language-plaintext highlighter-rouge">commons-io-1.4.jar</code> and <code class="language-plaintext highlighter-rouge">commons-lang-2.5.jar</code> to run. These would support full scheduler with in memory data store. As you can see these add up to only about 500K!</p>

<p>To be able to see useful logging output, you need an SLF4j impl. You may use built-in JDK’s logger if you choose, or you may use <code class="language-plaintext highlighter-rouge">slf4j-log4j12-1.6.1.jar</code> and <code class="language-plaintext highlighter-rouge">log4j-1.2.16.jar</code>. I personally think the JDK logger is horrible to use and configure, so I package up log4j as option for you.</p>

<p>A Java scripting engine is only optional in TimeMachine, and JDK already comes with JavaScript. To be practical, I also package the Groovy engine <code class="language-plaintext highlighter-rouge">groovy-all-2.0.0.jar</code>. It’s much more easy to use. But the full groovy engine is costing us 6M in size!</p>

<p>The TimeMachine allows you to switch data store service. We provided the <code class="language-plaintext highlighter-rouge">HibernateDataService</code> service in <code class="language-plaintext highlighter-rouge">timemachine-scheduler-1.2.1.jar</code>. This service would require the Hibernate dependencies, which is pretty heavy. They are: <code class="language-plaintext highlighter-rouge">hibernate-*.jar</code>, <code class="language-plaintext highlighter-rouge">jboss-*.jar</code>, <code class="language-plaintext highlighter-rouge">javassist-3.15.0-GA.jar</code>, <code class="language-plaintext highlighter-rouge">antlr-2.7.7.jar</code>, and <code class="language-plaintext highlighter-rouge">dom4j-1.6.1.jar</code>. These can add up to another 5M in size!</p>

<p>Now with the Hibernate data service, you would also need a database driver that match to your database. I have included a H2Database, a Java database that provides full SQL database service including its driver in <code class="language-plaintext highlighter-rouge">h2-1.3.163.jar</code>. This alone is about 1.2M in size.</p>

<p>When you working with Hibernate and Database, you should always use a Database connection pool. I packaged the <code class="language-plaintext highlighter-rouge">c3p0-0.9.1.2.jar</code> implementation which Hibernate can automatically detects.</p>

<p>I hope these information can help you decide what to remove or add in case you want to customize your scheduler to fit into your application. You may also visit the project to see the Maven site dependencies report that has all the details. This also means that if you use Maven to bring in TimeMachine scheduler as dependency, you will automatically gets the minimal because I have carefully set all the optional items not to be included with the proper Maven scopes.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/08/01/a-better-java-shell-script-wrapper/">
        A better java shell script wrapper
      </a>
    </h1>

    <span class="post-date">01 Aug 2012</span>

    <p>In many Java projects, you often see wrapper shell script to invoke the <code class="language-plaintext highlighter-rouge">java</code> command with its custom application parameters. For example, <code class="language-plaintext highlighter-rouge">$ANT_HOME/bin/ant</code>, <code class="language-plaintext highlighter-rouge">$GROOVY_HOME/bin/groovy</code>, or even in our <a href="http://bitbucket.org/timemachine/scheduler">TimeMachine Scheduler</a> you will see <code class="language-plaintext highlighter-rouge">$TIMEMACHINE_HOME/bin/scheduler.sh</code>.</p>

<p>Writing these wrapper script is boring and error prone. Most of the problems come from setting the correct classpath for the application. If you’re working on an in-house project for a company, then you can get away with hardcoding paths and your environment vars. But for open source projects, folks have to make the wrapper more flexible and generic. Most of them even provide a <code class="language-plaintext highlighter-rouge">.bat</code> version of it. Windows DOS is really a brutal and limited terminal to script away your project need. For this reason, I often encourage others to use Cygwin as much as they can. It at least has a real bash shell to work with. Another common problem with these wrappers is it can quickly get out of hand and have too many duplication of similar scripts liter every where in your project.</p>

<p>In this post, I will show you a Java wrapper script that I’ve written. It’s simple to use and very flexible for running just about any Java program. Let’s see how it’s used first, and then I will print its content at the bottom of the post.</p>

<h2 id="introducing-the-run-java-wrapper-script">Introducing the <code class="language-plaintext highlighter-rouge">run-java</code> wrapper script</h2>

<p>If you take a look at <code class="language-plaintext highlighter-rouge">$TIMEMACHINE_HOME/bin/scheduler.sh</code>, you will see that it in turns calls a <code class="language-plaintext highlighter-rouge">run-java</code> script that comes in the same directory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DIR=$(dirname $0)
SCHEDULER_HOME=$DIR/..
$DIR/run-java -Dscheduler.home="$SCHEDULER_HOME" timemachine.scheduler.tool.SchedulerServer "$@"
</code></pre></div></div>

<p>As you can see, our <code class="language-plaintext highlighter-rouge">run-java</code> can take <code class="language-plaintext highlighter-rouge">-D</code> options. Not only this, it can also take <code class="language-plaintext highlighter-rouge">-cp</code> option as well! What’s more is that you can specify these options even <strong>after</strong> the main class! This makes the <code class="language-plaintext highlighter-rouge">run-java</code> re-wrappable by other script, and still be able to add additional system properties and classpath.</p>

<p>For examples, the TimeMachine comes with Groovy library, so instead of downloading it’s full distribution again, you can simply invoke the groovy like this</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$TIMEMACHINE_HOME/bin/run-java groovy.ui.GroovyMain test.groovy
</code></pre></div></div>

<p>You can use <code class="language-plaintext highlighter-rouge">run-java</code> in any directory you’re in, so it’s convenient. It will resolve it’s own directory and load any jars in the <code class="language-plaintext highlighter-rouge">lib</code> directory automatically. Now if you want Groovy to run with more additional jars, you can use the <code class="language-plaintext highlighter-rouge">-cp</code> option like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$TIMEMACHINE_HOME/bin/run-java -cp "$HOME/apps/my-app/lib/*" groovy.ui.GroovyMain test.groovy
</code></pre></div></div>

<p>Often times things will go wrong if you are not careful with Java classpath, but with <code class="language-plaintext highlighter-rouge">run-java</code> script you can perform a dry run first:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RUN_JAVA_DRY=1 $TIMEMACHINE_HOME/bin/run-java -cp "$HOME/apps/my-app/lib/*" groovy.ui.GroovyMain test.groovy
</code></pre></div></div>

<p>You would run the above all in single line on a command prompt. It should print out your full java command with all options and arguments for you to inspect.</p>

<p>There are many more options to the script, which you can find out more by reading the comments in it. The current script will work on any Linux bash or on a Windows Cygwin terminal.</p>

<h2 id="using-run-java-during-development-with-maven">Using <code class="language-plaintext highlighter-rouge">run-java</code> during development with Maven</h2>

<p>Above examples are assuming you are in a released project structure such as this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $TIMEMACHINE_HOME
      +- bin/run-java
      +- lib/*.jar
</code></pre></div></div>

<p>But what about during development? A frequent use case is that you want to be able to run your latest compiled classes under <code class="language-plaintext highlighter-rouge">target/classes</code> without have to package up or release the entire project. You can use our <code class="language-plaintext highlighter-rouge">run-java</code> in these scenario as well. First, simply add <code class="language-plaintext highlighter-rouge">bin/run-java</code> in your project, then you run <code class="language-plaintext highlighter-rouge">mvn compile dependency:copy-dependencies</code> that will generate all the <code class="language-plaintext highlighter-rouge">jar</code> files into <code class="language-plaintext highlighter-rouge">target/dependency</code>. That’s all. The <code class="language-plaintext highlighter-rouge">run-java</code> will automatically detect these directories and create the correct classpath to run your main class.</p>

<p>If you use Eclipse IDE for development, then your <code class="language-plaintext highlighter-rouge">target/classes</code> will be always up-to-date, and the <code class="language-plaintext highlighter-rouge">run-java</code> can be a great gem to have in your project even for development.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/07/30/how-to-print-text-file-content-inside-a-jar-file/">
        How to print text file content inside a jar file
      </a>
    </h1>

    <span class="post-date">30 Jul 2012</span>

    <p>Have you ever wonder what’s the exact version of your <code class="language-plaintext highlighter-rouge">ojdbc6.jar</code> that you have? All the jar files will contain a <code class="language-plaintext highlighter-rouge">META-INF/MANIFEST.MF</code> file, and chances are the version will be in it! You may try using <code class="language-plaintext highlighter-rouge">$JAVA_HOME/bin/jar -xvf</code> to extract the jar and then view the text file. But afterward you would have to clean up the extracted file so not to liter.</p>

<p>However, if you got Groovy, you can print any text file inside a jar without above mess.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file = new File(args[0])
name = args.size() &gt; 1 ? args[1] : "META-INF/MANIFEST.MF"
jar = new java.util.jar.JarFile(file)
entry = jar.getEntry(name)
istream = jar.getInputStream(entry)
println(istream.text)
istream.close()
</code></pre></div></div>

<p>You may use this script like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ groovy printjar.groovy /path/to/objdbc6.jar

# Or give an explicit entry name
$ groovy printjar.groovy $JBOSS_HOME/jboss-modules.jar 'META-INF/maven/org.jboss.modules/jboss-modules/pom.properties'
</code></pre></div></div>

<p>UPDATES:</p>

<p>Here are different implementations of similar program in differnet JVM based languages.</p>

<p>Java</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import java.io.BufferedReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.Enumeration;
import java.util.jar.JarEntry;
import java.util.jar.JarFile;

/**
 * Print text based resource file inside a jar file. (eg: META-INF/MANIFEST.MF)
 * 
 * @author Zemian Deng
 */
public class printjar {
    public static void main(String[] args) throws Exception {
        // Search given name in a jar
        JarFile jarFile = new JarFile(args[0]);
        final String searchName = (args.length &gt;= 2) ? args[1]
                : "META-INF/MANIFEST.MF";

        Enumeration&lt;JarEntry&gt; entries = jarFile.entries();
        while (entries.hasMoreElements()) {
            JarEntry entry = entries.nextElement();
            if (entry.getName().contains(searchName)) {
                // Print the JarEntry
                InputStream instream = jarFile.getInputStream(entry);
                try {
                    BufferedReader reader = new BufferedReader(
                            new InputStreamReader(instream));
                    String line = null;
                    while ((line = reader.readLine()) != null) {
                        System.out.println(line);
                    }
                } finally {
                    if (instream != null)
                        instream.close();
                }
            }
        }
    }
}
</code></pre></div></div>

<p>JavaScript (Run it with <code class="language-plaintext highlighter-rouge">jrunscript</code> command)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jar = new java.util.jar.JarFile(arguments[0])
pattern = arguments[arguments.length -1];
entries = jar.entries();
while(entries.hasMoreElements()) {
    jarEntry = entries.nextElement();
    if (jarEntry.toString().search(pattern) != -1) {
        istream = jar.getInputStream(jarEntry);
        cat(istream);
        istream.close();
        break;
    }
}
jar.close();
</code></pre></div></div>

<p>Kotlin</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import java.io.BufferedReader
import java.io.InputStreamReader
import java.util.jar.JarFile
val jarFile = JarFile(args[0])
val searchName = if (args.size() &gt;= 2) args[1] else "META-INF/MANIFEST.MF"
for (entry in jarFile.entries()) {
    if (entry.getName().contains(searchName)) {
        jarFile.getInputStream(entry).use { it -&gt;
            val reader = BufferedReader(InputStreamReader(it))
            for (line in reader.lineSequence())
            println(line)
        }
    }
}
</code></pre></div></div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/07/28/getting-jboss-cli-sh-to-work-on-macosx/">
        Getting jboss-cli.sh to work on MacOSX
      </a>
    </h1>

    <span class="post-date">28 Jul 2012</span>

    <p>If you use MacOSX and JBossAS, then you might have encountered this problem when using the jboss-client.sh tool:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bin/jboss-cli.sh 
</code></pre></div></div>

<p>You are disconnected at the moment. Type ‘connect’ to connect to the server or ‘help’ for the list of supported commands.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[disconnected /] connect
The controller is not available at localhost:9999
</code></pre></div></div>

<p>Or you will get this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bin/jboss-cli.sh --connect
org.jboss.as.cli.CliInitializationException: Failed to connect to the controller
at org.jboss.as.cli.impl.CliLauncher.initCommandContext(CliLauncher.java:229)
at org.jboss.as.cli.impl.CliLauncher.main(CliLauncher.java:207)
at org.jboss.as.cli.CommandLineMain.main(CommandLineMain.java:34)
at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
at java.lang.reflect.Method.invoke(Method.java:601)
at org.jboss.modules.Module.run(Module.java:260)
at org.jboss.modules.Main.main(Main.java:291)
Caused by: org.jboss.as.cli.CommandLineException: The controller is not available at localhost:9999
at org.jboss.as.cli.impl.CommandContextImpl.connectController(CommandContextImpl.java:639)
at org.jboss.as.cli.impl.CommandContextImpl.connectController(CommandContextImpl.java:613)
at org.jboss.as.cli.impl.CliLauncher.initCommandContext(CliLauncher.java:227)
... 8 more
</code></pre></div></div>

<p>It turns out this is bug on the JDK 1.7 that only appears on MacOSX JDK7! To be exact, I have the following: MacOSX 10.7.4 with JDK 1.7.0_05 and JBossAS 7.1.1.Final.</p>

<p>This problem has already been discovered by these posts:</p>

<p><a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7159361">http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=7159361</a></p>

<p><a href="https://community.jboss.org/message/750861#750861">https://community.jboss.org/message/750861#750861</a></p>

<p>Except after ready through all, and I can’t still get it to work because no one listed a clear steps by steps solution. So I re-summarize it again. You need to use that bug’s report workaround solution on both the server and client!</p>

<p>Start the server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $ bin/standalone.sh -Djava.nio.channels.spi.SelectorProvider=sun.nio.ch.KQueueSelectorProvider 
    ... 
    18:37:22,555 INFO  [org.jboss.as] (Controller Boot Thread) JBAS015874: JBoss AS 7.1.1.Final "Brontes" started in 1686ms - Started 133 of 208 services (74 services are passive or on-demand)
</code></pre></div></div>

<p>And on separate terminal, run the CLI:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    $JAVA_OPTS="-Djava.nio.channels.spi.SelectorProvider=sun.nio.ch.KQueueSelectorProvider" bin/jboss-cli.sh --connect 
    [standalone@localhost:9999 /] 
</code></pre></div></div>

<p>There, now we may continue to explore the cool JBossAS on the fancy OS.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/07/23/using-timemachine-scheduler-on-jbossas-7/">
        Using TimeMachine Scheduler on JBossAS 7
      </a>
    </h1>

    <span class="post-date">23 Jul 2012</span>

    <p>I’ve written an article for MasterTheBoss.com on integrating
<a href="http://mastertheboss.com/jboss-quartz/using-timemachine-scheduler-on-jbossas-7">TimeMachine Scheduler on
JBossAS7</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://localhost:4000/2012/07/21/script-console-tool-for-any-war-application/">
        Script Console Tool for any WAR application
      </a>
    </h1>

    <span class="post-date">21 Jul 2012</span>

    <p>In the latest release of <a href="https://bitbucket.org/timemachine/scheduler">TimeMachine scheduler project</a>, I’ve added a Groovy scripting console to the web app and allow user to script the scheduler. This feature is actually very useful for any servlet application as well. Imagine that if you have a script/shell console for your web application that allow you to dynamically inspect any variables or data?</p>

<p>With the same idea, I’ve written a very basic JSP file <code class="language-plaintext highlighter-rouge">script-console.jsp</code> that provides a great ad hoc tool. For simplicity sake, I put everything into single file. All you need is just add this one file into your java webapp root directory, and you’ll have an instant scripting console shell! (Yes, I am aware having code in JSP is bad, but having everything in one page is convenient, specially if you plan to just use this as one time inspection.)</p>

<p>The JSP will automatically detect all the scripting engine available in your JVM (1.6+) and let you choose any one to use. In the text area you can enter any script codes. All the JSP implicit variables are available for you to use as well. JVM 1.6 or higher will have at least JavaScript engine available, so you can use it immediately.</p>

<p>Be aware that this is a huge security risk since the script console not only expose your application, it also expose your entire JVM! It must be use with care, and if possible, it needs to be added as protected resources in your web application.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="http://localhost:4000/page26">Older</a>
  
  
    
      <a class="pagination-item newer" href="http://localhost:4000/page24">Newer</a>
    
  
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
