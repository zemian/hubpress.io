<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      How to integrate TimeMachine Scheduler in Spring based application &middot; Zemian's Blog
    
  </title>

  
  <link rel="canonical" href="http://localhost:4000/2012/08/17/how-to-integrate-timemachine-scheduler-in-spring-based-application/">
  

  <link rel="stylesheet" href="http://localhost:4000/public/css/poole.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/syntax.css">
  <link rel="stylesheet" href="http://localhost:4000/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="http://localhost:4000/public/favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="RSS" href="http://localhost:4000/atom.xml">

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-135626598-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A weblog on software development.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://localhost:4000/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="http://localhost:4000/about/">About</a>
        
      
    
      
    
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2020. All rights reserved.
    </p>
  </div>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Zemian's Blog</a>
            <small>Life in programming world!</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">How to integrate TimeMachine Scheduler in Spring based application</h1>
  <span class="post-date">17 Aug 2012</span>
  <p>One of the goals for <a href="https://bitbucket.org/timemachine/scheduler">TimeMachine Scheduler</a> is to make use of POJO as friendly as possible so that we can integrate into any IoC container easily. I’ve prepared a demo that will show you how to integrate TimeMachine with <a href="http://www.springsource.org/">Spring</a> based application.</p>

<p>We will mainly focus on the Spring xml config part in this article, so if you don’t feel like checking out the  <a href="https://bitbucket.org/timemachine/scheduler-demo/src/fab518eb64ce/scheduler-spring">demo project source code</a> in details, then simply grab the binary package of the  <a href="https://bitbucket.org/timemachine/scheduler-demo/downloads">timemachine-spring-demo.zip</a> and follow along.</p>

<h1 id="introducing-a-tiny-spring-server">Introducing a tiny Spring Server</h1>

<p>If you don’t already have a Spring project going, then take a look at my little Spring server. It can bootstrap any spring configuration xml file and then sits and wait for a <code class="language-plaintext highlighter-rouge">CTRL+C</code> to end. Unzip the demo and try it out like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd timemachine-spring-demo
$ bin/run-spring config/hello-spring.xml
</code></pre></div></div>

<p>You should see a “Hello World!” message printed. Hit <code class="language-plaintext highlighter-rouge">CTRL+C</code> to end it. The xml just declares a simple <code class="language-plaintext highlighter-rouge">HelloService</code> bean like this.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;beans xmlns="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;
    
        &lt;bean id="helloService" class="timemachine.spring.HelloService" init-method="run"&gt;
            &lt;property name="name" value="World"&gt;&lt;/property&gt;
        &lt;/bean&gt;
    
    &lt;/beans&gt;
</code></pre></div></div>

<p>That’s your typical Spring declaration file. With this tiny Spring server, you can quickly experiment any POJOs wired up in any way you wish and put them in action.</p>

<h1 id="setting-up-timemachine-scheduler-beans">Setting up TimeMachine Scheduler beans</h1>

<p>In Java code, you can easily create an instance of the TimeMachine scheduler as follow:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    SchedulerFactory schedulerFactory = new SchedulerFactory("config/scheduler.properties");
    Scheduler scheduler = schedulerFactory.createScheduler();
    scheduler.start();
    // Then we would also need to call scheduler.destroy() before we exit the Java program. (eg: in shutdownHook)
</code></pre></div></div>

<p>You can easily translate that into Spring xml config like in <code class="language-plaintext highlighter-rouge">config/timemachine-pojo-spring.xml</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;beans xmlns="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;
    
        &lt;bean id="schedulerFactory" class="timemachine.scheduler.SchedulerFactory"&gt;
            &lt;constructor-arg value="config/scheduler.properties"&gt;&lt;/constructor-arg&gt;
        &lt;/bean&gt;
        &lt;bean id="scheduler" class="timemachine.scheduler.Scheduler" 
            factory-bean="schedulerFactory" factory-method="createScheduler"
            init-method="start" destroy-method="destroy"&gt;
        &lt;/bean&gt;
    
    &lt;/beans&gt;
</code></pre></div></div>

<p>The benefit of using Spring xml is that your scheduler lifecycles would be automatically taken care of without setting any shutdown hook. Running above should give you a plain scheduler started, and pressing <code class="language-plaintext highlighter-rouge">CTRL+C</code> should shutdown gracefully.</p>

<h1 id="going-further-with-a-custom-schedulerfactorybean">Going further with a custom SchedulerFactoryBean</h1>

<p>Now above is not much excitement using Spring since you would still configure the scheduler through <code class="language-plaintext highlighter-rouge">config/scheduler.properties</code>. You certainly can load jobs and add custom services there. But if we are going to use Spring, we might as well take full advantage of it to create the Job Definition and Schedule inside the xml config! To do this, I created a simple <code class="language-plaintext highlighter-rouge">timemachine.scheduler.spring.SchedulerFactoryBean</code> in my demo project, and you can try it out like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;beans xmlns="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;
    
        &lt;bean id="scheduler" class="timemachine.scheduler.spring.SchedulerFactoryBean"&gt;
            &lt;property name="configPropsUrl" value="config/scheduler.properties"&gt;&lt;/property&gt;
            &lt;property name="autoStart" value="true"&gt;&lt;/property&gt;
            &lt;property name="autoAddJobDef" value="true"&gt;&lt;/property&gt;
        &lt;/bean&gt;
        &lt;bean id="jobDef01" class="timemachine.scheduler.JobDef"&gt;
            &lt;property name="jobTaskClassName" value="timemachine.scheduler.jobtask.ScriptingJobTask"&gt;&lt;/property&gt;
            &lt;property name="props"&gt;
                &lt;map&gt;
                    &lt;entry key="scriptEngineName" value="Groovy"&gt;&lt;/entry&gt;
                    &lt;entry key="scriptText" value="println('Hello World.')"&gt;&lt;/entry&gt;
                &lt;/map&gt;
            &lt;/property&gt;
            &lt;property name="schedules"&gt;
                &lt;list&gt;              
                    &lt;bean class="timemachine.scheduler.schedule.CronSchedule"&gt;
                        &lt;property name="expression" value="0/3 * * * * ?"&gt;&lt;/property&gt;
                    &lt;/bean&gt;
                &lt;/list&gt;
            &lt;/property&gt;
        &lt;/bean&gt;
    
    &lt;/beans&gt;
</code></pre></div></div>

<p>Above will create not only the scheduler but also auto manage the lifecycles for you without you explicitly declare it. The factory bean will also auto detect any JobDef and Schedule bean types and add them into the scheduler instance. This would make your scheduler config all in the Spring xml, and it’s well integrated.</p>

<p>There is also another similar sample in <code class="language-plaintext highlighter-rouge">config/timemachine-spring.xml</code> you may try. It will invoke an external groovy script instead of inline text.</p>

<h1 id="going-extra-mile-on-exposing-timemachine-scheduler-through-jmx">Going extra mile on exposing TimeMachine Scheduler through JMX</h1>

<p>The TimeMachine doesn’t support any JMX instrumentation, however when running with the Spring, you can easily expose any Java interface to the local MBean Server Platform using Spring’s MBeanExporter. For example in <code class="language-plaintext highlighter-rouge">config/timemachine-jmx-spring.xml</code> you will see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;beans xmlns="http://www.springframework.org/schema/beans"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://www.springframework.org/schema/beans
         http://www.springframework.org/schema/beans/spring-beans-3.0.xsd"&gt;
    
        &lt;bean id="scheduler" class="timemachine.scheduler.spring.SchedulerFactoryBean"&gt;
            &lt;property name="configPropsUrl" value="config/scheduler.properties"/&gt;
        &lt;/bean&gt; 
        &lt;bean id="exporter" class="org.springframework.jmx.export.MBeanExporter"&gt;
            &lt;property name="assembler"&gt;
                &lt;bean class="org.springframework.jmx.export.assembler.InterfaceBasedMBeanInfoAssembler"&gt;
                    &lt;property name="managedInterfaces"&gt;
                        &lt;list&gt;
                            &lt;value&gt;timemachine.scheduler.Scheduler&lt;/value&gt;
                        &lt;/list&gt;
                    &lt;/property&gt;
                &lt;/bean&gt;
            &lt;/property&gt;
            &lt;property name="beans"&gt;
                &lt;map&gt;
                    &lt;entry key="timemachine.scheduler:name=Scheduler" value-ref="scheduler"/&gt;
                &lt;/map&gt;
            &lt;/property&gt;
        &lt;/bean&gt;
    
    &lt;/beans&gt;
</code></pre></div></div>

<p>Above will start an empty scheduler, and expose the <code class="language-plaintext highlighter-rouge">timemachine.scheduler.Scheduler</code> interface to the JMX local server. You may use <code class="language-plaintext highlighter-rouge">$JAVA_HOME/bin/jconsole</code> to connect and will see all the methods automatically exposed. There few methods that contains custom java objects that exporter will not able to convert properly, but at least you will get all the lifecycles and some simple getters that available to you.</p>

</div>


<div class="related">
  <h2>Related posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2020/09/20/world-of-php/">
            The World of PHP Development
            <small>20 Sep 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/09/19/multiple-jquery/">
            How to Load Multiple jQuery
            <small>19 Sep 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2020/08/15/switched-to-vuepress/">
            Switched Blogging to VuePress
            <small>15 Aug 2020</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script src='/public/js/script.js'></script>
  </body>
</html>
